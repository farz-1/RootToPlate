variables:
  DJANGO_CONFIG: "test"
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/.cache/pip"

default:
  image: python
  tags: 
    - docker
  
  cache:
    paths:
      - .cache/pip/
      - venv/

  before_script:
    - pip3 install virtualenv
    - virtualenv venv
    - source venv/bin/activate
    - pip install -r requirements.txt

stages:
  - build
  - test

migrations:
  stage: build
  script:
    - cd roottoplate
    - python3 manage.py makemigrations
    - python3 manage.py makemigrations composter
    - python3 manage.py migrate
    - python3 population_script.py
    - python3 manage.py migrate
    - python3 manage.py check


django-tests:
  stage: test
  script:
    - cd roottoplate
    - python3 manage.py test

static-analysis:
  stage: test
  script:
    - python -m pip install flake8
    - flake8 --extend-exclude=venv/ --max-line-length 130


pages:
  stage: deploy
  script:
  - mkdir .public
  - cp -r * .public
  - mv .public public
  artifacts:
    paths:
    - public
  only:
  - main
