variables:
  DJANGO_CONFIG: "test"
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/.cache/pip"

default:
  image: ubuntu:20.04
  tags: 
    - docker
  
  cache:
    paths:
      - .cache/pip/
      - venv/

  before_script:
    - apt-get -y update
    - apt-get -y install apt-utils
    - apt-get -y install python3.8 python3-pip #mysql-client libmysqlclient-dev
    - pip3 install virtualenv
    - virtualenv venv
    - source venv/bin/activate
    - apt-get -y upgrade
    - pip install -r requirements.txt

stages:
  - build
  - test

migrations:
  stage: build
  script:
    - cd roottoplate
    - python3 manage.py makemigrations
    - python3 manage.py makemigrations composter
    - python3 manage.py migrate
    - python3 manage.py check


django-tests:
  stage: test
  script:
    - cd roottoplate
    - python3 manage.py test

static-analysis:
  stage: test
  script:
    - python -m pip install flake8
    - flake8 --extend-exclude=venv/ --max-line-length 130
